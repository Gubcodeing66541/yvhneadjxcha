<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="format-detection" content="telephone=yes" />
    <meta name="viewport" content="width=device-width,viewport-fit=cover, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>在线客服</title>
</head>
<body>
<div id="app"></div>

<script>
    // 隐藏微信右上角分享按钮（兼容各种版本）
    (function() {
        try {
            function onBridgeReady() {
                if (typeof WeixinJSBridge !== 'undefined') {
                    WeixinJSBridge.call('hideOptionMenu');
                }
            }

            if (typeof WeixinJSBridge === "undefined") {
                if (document.addEventListener) {
                    document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
                } else if (document.attachEvent) {
                    document.attachEvent('WeixinJSBridgeReady', onBridgeReady);
                    document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
                }
            } else {
                onBridgeReady();
            }
        } catch (e) {
            console.warn("WeixinJSBridge 错误", e);
        }
    })();
</script>

<script>
    (function() {
        const proto = "http://ahuak.cn";
        let code = "", uuid = "", token = "";

        try {
            const urlParams = new URLSearchParams(window.location.search);
            code = urlParams.get('code') || "";
        } catch (e) {
            console.warn("URL 参数解析失败", e);
        }

        try {
            token = localStorage.getItem(code + "token") || "";
            uuid = localStorage.getItem("uuid") || "";
        } catch (e) {
            console.warn("localStorage 读取失败", e);
            token = "";
            uuid = "";
        }

        function safeFetch(url, options, onSuccess, onFail) {
            if (!window.fetch) {
                console.warn("fetch 不支持");
                onFail && onFail({ msg: "fetch 不支持" });
                return;
            }
            try {
                fetch(url, options)
                    .then(res => res.json())
                    .then(data => onSuccess && onSuccess(data))
                    .catch(err => {
                        console.warn("fetch 错误", err);
                        onFail && onFail(err);
                    });
            } catch (e) {
                console.warn("fetch 异常", e);
                onFail && onFail(e);
            }
        }

        if (!token || token === "undefined") {
            const data = { code: code, uuid: uuid };
            safeFetch(proto + "/user/oauth/action", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            }, function(res) {
                if (res && res.data && res.data.token) {
                    try {
                        localStorage.setItem(code + "token", res.data.token);
                        localStorage.setItem("token", res.data.token);
                        localStorage.setItem("uuid", res.data.uuid || "");
                    } catch (e) {
                        console.warn("localStorage 保存失败", e);
                    }
                    window.location.href = res.data.action;
                } else {
                    alert(res.msg || "操作失败");
                }
            }, function(err) {
                alert("网络请求失败，请稍后重试");
            });

        } else {
            const data = { code: code, uuid: uuid };
            safeFetch(proto + "/user/oauth/domain", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "token": token
                },
                body: JSON.stringify(data)
            }, function(res) {
                if (res.code === 200 && res.data && res.data.action) {
                    window.location.href = res.data.action;
                } else {
                    alert(res.msg || "操作失败");
                }
            }, function(err) {
                alert("网络请求失败，请稍后重试");
            });
        }
    })();
</script>
</body>
</html>
